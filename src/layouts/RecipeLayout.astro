---
import Layout from "./Layout.astro";
import type { Article, Author, FaqItem, Category } from "../types";
import SocialShareBar from "../components/SocialShareBar.astro";
import RecipeAuthorCard from "../components/RecipeAuthorCard.astro";
import PopularRecipes from "../components/PopularRecipes.astro";
import NewsletterWidget from "../components/NewsletterWidget.astro";
import { extractImage, getImageSrcSet } from "@shared/utils";

interface Props {
  recipe: Article;
  author?: Author | null;
  category?: Category | null;
}

const { recipe, author, category } = Astro.props;
const categoryColor = category?.color || "#ff6600";

// Parse recipeJson if it's a string
const recipeJson = recipe.recipeJson
  ? typeof recipe.recipeJson === "string"
    ? JSON.parse(recipe.recipeJson)
    : recipe.recipeJson
  : null;

// Calculate estimated reading time (approx 200 words per minute)
const wordCount = [
  recipe.shortDescription,
  recipe.tldr,
  recipe.introduction,
  JSON.stringify(recipeJson?.ingredients || []),
  JSON.stringify(recipeJson?.instructions || []),
]
  .filter(Boolean)
  .join(" ")
  .split(/\s+/).length;

const readingTime = Math.max(5, Math.ceil(wordCount / 200));

const heroCover = extractImage(recipe.imagesJson, "cover", 1200);
const heroThumb = extractImage(recipe.imagesJson, "thumbnail", 1200);
const coverSrcSet = getImageSrcSet(recipe.imagesJson, "cover");
const thumbSrcSet = getImageSrcSet(recipe.imagesJson, "thumbnail");
const useCover = heroCover.imageUrl && (coverSrcSet || !heroThumb.imageUrl);
const heroSlotName = useCover ? "cover" : "thumbnail";
const heroImage = useCover ? heroCover : heroThumb;
const heroSrcSet = useCover ? coverSrcSet : thumbSrcSet;
const heroSizes = "(max-width: 768px) 100vw, 800px";

const authorAvatar = author?.imagesJson
  ? extractImage(author.imagesJson, "avatar", 96)
  : {};
const authorImage = authorAvatar.imageUrl || author?.imageUrl;
---

<Layout
  title={recipe.metaTitle || recipe.label}
  description={recipe.metaDescription || recipe.shortDescription}
  image={heroImage.imageUrl || recipe.imageUrl || undefined}
>
  {
    (heroImage.imageUrl || recipe.imageUrl) && (
      <link
        slot="head"
        rel="preload"
        as="image"
        href={heroImage.imageUrl || recipe.imageUrl}
      />
    )
  }
  <article class="recipe-page">
    <div class="recipe-container">
      <!-- Main Content Column -->
      <div class="main-content">
        <!-- Category Badge -->
        {
          recipe.categoryLabel && (
            <a
              href={`/categories/${recipe.categorySlug}`}
              class="category-badge"
              style={`--badge-color: ${categoryColor};`}
            >
              {recipe.categoryLabel}
            </a>
          )
        }

        <!-- Recipe Title -->
        <h1 class="recipe-title">{recipe.label}</h1>

        <!-- Short Description -->
        {
          recipe.shortDescription && (
            <p class="recipe-description">{recipe.shortDescription}</p>
          )
        }

        <!-- Social Share Bar -->
        <SocialShareBar
          title={recipe.label}
          readingTime={`${readingTime} Min Read`}
        />

        <!-- Author Card -->
        <RecipeAuthorCard
          authorName={author?.name || recipe.authorName}
          authorImage={authorImage || undefined}
          authorRole={author?.job || "Blogger"}
          lastUpdated={recipe.publishedAt || undefined}
          viewCount={recipe.viewCount}
        />

        <!-- Disclosure Notice -->
        <div class="disclosure-notice">
          <strong>Disclosure:</strong> This website may contain affiliate links, which
          means I may earn a commission if you click on the link and make a purchase.
          I only recommend products or services that I personally use and believe
          will add value to my readers. Your support is appreciated!
        </div>

        <!-- Hero Image -->
        {
          (heroImage.imageUrl || recipe.imageUrl) && (
            <div class="hero-image">
              <img
                src={heroImage.imageUrl || recipe.imageUrl}
                alt={heroImage.imageAlt || recipe.imageAlt || recipe.label}
                width={heroImage.imageWidth || recipe.imageWidth}
                height={heroImage.imageHeight || recipe.imageHeight}
                srcset={heroSrcSet || undefined}
                sizes={heroSrcSet ? heroSizes : undefined}
                loading="eager"
                fetchpriority="high"
              />
            </div>
          )
        }

        <!-- Recipe Meta Info Pills -->
        {
          recipeJson && (
            <div class="recipe-meta-pills">
              {recipeJson.prepTime && (
                <div class="meta-pill">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <circle cx="12" cy="12" r="10" />
                    <polyline points="12 6 12 12 16 14" />
                  </svg>
                  <span class="label">Prep</span>
                  <span class="value">{recipeJson.prepTime}</span>
                </div>
              )}
              {recipeJson.cookTime && (
                <div class="meta-pill">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83" />
                  </svg>
                  <span class="label">Cook</span>
                  <span class="value">{recipeJson.cookTime}</span>
                </div>
              )}
              {recipeJson.servings && (
                <div class="meta-pill">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                    <circle cx="9" cy="7" r="4" />
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                    <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                  </svg>
                  <span class="label">Servings</span>
                  <span class="value">{recipeJson.servings}</span>
                </div>
              )}
              {recipeJson.difficulty && (
                <div class="meta-pill">
                  <svg
                    class="icon"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                  </svg>
                  <span class="label">Level</span>
                  <span class="value">{recipeJson.difficulty}</span>
                </div>
              )}
            </div>
          )
        }

        <!-- TLDR / Quick Overview -->
        {
          recipe.tldr && (
            <section class="content-section tldr-section">
              <h2>Quick Overview</h2>
              <div class="prose" set:html={recipe.tldr} />
            </section>
          )
        }

        <!-- Ingredients -->
        {
          recipeJson?.ingredients &&
            Array.isArray(recipeJson.ingredients) &&
            recipeJson.ingredients.length > 0 && (
              <section class="content-section ingredients-section">
                <h2>Ingredients</h2>
                {recipeJson.ingredients.map(
                  (group: { group: string; items: string[] }) => (
                    <div class="ingredient-group">
                      {group.group && <h3>{group.group}</h3>}
                      <ul class="ingredient-list">
                        {group.items &&
                          Array.isArray(group.items) &&
                          group.items.map((item: string) => (
                            <li>
                              <span class="checkbox" />
                              <span>{item}</span>
                            </li>
                          ))}
                      </ul>
                    </div>
                  ),
                )}
              </section>
            )
        }

        <!-- Instructions -->
        {
          recipeJson?.instructions &&
            Array.isArray(recipeJson.instructions) &&
            recipeJson.instructions.length > 0 && (
              <section class="content-section instructions-section">
                <h2>Instructions</h2>
                {recipeJson.instructions.map(
                  (group: { group: string; steps: string[] }) => (
                    <div class="instruction-group">
                      {group.group && <h3>{group.group}</h3>}
                      <ol class="instruction-list">
                        {group.steps &&
                          Array.isArray(group.steps) &&
                          group.steps.map((step: string, index: number) => (
                            <li>
                              <span class="step-number">{index + 1}</span>
                              <p>{step}</p>
                            </li>
                          ))}
                      </ol>
                    </div>
                  ),
                )}
              </section>
            )
        }

        <!-- Nutrition Facts (inline for mobile) -->
        {
          recipeJson?.nutrition &&
            Object.keys(recipeJson.nutrition).length > 0 && (
              <section class="content-section nutrition-section mobile-only">
                <h2>Nutrition Facts</h2>
                <div class="nutrition-grid">
                  {Object.entries(recipeJson.nutrition).map(([key, value]) => (
                    <div class="nutrition-item">
                      <span class="nutrition-value">{value}</span>
                      <span class="nutrition-label">{key}</span>
                    </div>
                  ))}
                </div>
              </section>
            )
        }

        <!-- FAQs -->
        {
          recipe.faqsJson &&
            Array.isArray(recipe.faqsJson) &&
            recipe.faqsJson.length > 0 && (
              <section class="content-section faqs-section">
                <h2>Frequently Asked Questions</h2>
                <div class="faq-list">
                  {recipe.faqsJson.map((faq: FaqItem) => (
                    <details class="faq-item">
                      <summary>{faq.question}</summary>
                      <div class="faq-answer" set:html={faq.answer} />
                    </details>
                  ))}
                </div>
              </section>
            )
        }
      </div>

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sidebar-sticky">
          <!-- Nutrition Facts (desktop) -->
          {
            recipeJson?.nutrition &&
              Object.keys(recipeJson.nutrition).length > 0 && (
                <div class="sidebar-widget nutrition-widget desktop-only">
                  <h3>Nutrition Facts</h3>
                  <div class="nutrition-list">
                    {Object.entries(recipeJson.nutrition).map(
                      ([key, value]) => (
                        <div class="nutrition-row">
                          <span class="nutrition-key">{key}</span>
                          <span class="nutrition-val">{value}</span>
                        </div>
                      ),
                    )}
                  </div>
                </div>
              )
          }

          <!-- Popular Recipes -->
          <PopularRecipes currentSlug={recipe.slug} limit={5} />

          <!-- Newsletter Widget -->
          <NewsletterWidget />
        </div>
      </aside>
    </div>
  </article>
</Layout>

<script define:vars={{ slug: recipe.slug }}>
  // Simple view tracking
  const trackView = async () => {
    try {
      await fetch(`/api/views/${slug}`, { method: "POST" });
    } catch (e) {
      // Ignore errors silently (e.g. ad blockers)
    }
  };

  // Run when the page is ready
  if (document.readyState === "complete") {
    trackView();
  } else {
    window.addEventListener("load", trackView);
  }
</script>

<style>
  .recipe-page {
    background: #fafafa;
    min-height: 100vh;
    padding-bottom: 4rem;
  }

  .recipe-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 2rem clamp(1rem, 3vw, 2rem);
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  @media (min-width: 1024px) {
    .recipe-container {
      grid-template-columns: 1fr 360px;
    }
  }

  /* Main Content */
  .main-content {
    background: #fff;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
  }

  /* Category Badge */
  .category-badge {
    display: inline-block;
    background: var(--badge-color, #ff6600);
    color: #fff;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0.375rem 0.875rem;
    border-radius: 4px;
    text-decoration: none;
    margin-bottom: 1rem;
    transition: filter 0.2s;
  }

  .category-badge:hover {
    filter: brightness(0.9);
  }

  /* Title */
  .recipe-title {
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 800;
    color: #111;
    line-height: 1.2;
    margin: 0 0 1rem;
  }

  /* Description */
  .recipe-description {
    font-size: 1.125rem;
    color: #555;
    line-height: 1.6;
    margin: 0 0 1.5rem;
  }

  /* Disclosure Notice */
  .disclosure-notice {
    background: #f8f8f8;
    border-left: 3px solid #ddd;
    padding: 1rem 1.25rem;
    font-size: 0.8125rem;
    color: #666;
    line-height: 1.6;
    margin: 1.5rem 0;
    border-radius: 0 8px 8px 0;
  }

  .disclosure-notice strong {
    color: #333;
  }

  /* Hero Image */
  .hero-image {
    margin: 1.5rem 0;
    overflow: hidden;
    border-radius: 12px;
  }

  .hero-image img {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 12px;
  }

  /* Recipe Meta Pills */
  .recipe-meta-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 1.5rem 0;
    border-bottom: 1px solid #eee;
    margin-bottom: 2rem;
  }

  .meta-pill {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: #f5f5f5;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    flex: 1;
    min-width: 120px;
  }

  .meta-pill .icon {
    width: 20px;
    height: 20px;
    color: #ff3366;
    flex-shrink: 0;
  }

  .meta-pill .label {
    font-size: 0.75rem;
    color: #888;
    text-transform: uppercase;
  }

  .meta-pill .value {
    font-size: 0.875rem;
    font-weight: 600;
    color: #333;
  }

  /* Content Sections */
  .content-section {
    margin-bottom: 2.5rem;
  }

  .content-section h2 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111;
    margin: 0 0 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #111;
  }

  .content-section h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: #333;
    margin: 1.5rem 0 0.75rem;
  }

  /* TLDR */
  .tldr-section {
    background: #fff8e6;
    margin: 0 -2rem 2.5rem;
    padding: 1.5rem 2rem;
    border-left: 4px solid #f59e0b;
  }

  .tldr-section h2 {
    border-bottom: none;
    padding-bottom: 0;
    margin-bottom: 0.75rem;
  }

  .prose {
    color: #444;
    line-height: 1.7;
  }

  /* Ingredients */
  .ingredient-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .ingredient-list li {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 0.625rem 0;
    border-bottom: 1px solid #f0f0f0;
    color: #333;
  }

  .checkbox {
    width: 20px;
    height: 20px;
    border: 2px solid #10b981;
    border-radius: 50%;
    flex-shrink: 0;
    margin-top: 2px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .ingredient-list li:hover .checkbox {
    background: #10b981;
  }

  /* Instructions */
  .instruction-list {
    list-style: none;
    padding: 0;
    margin: 0;
    counter-reset: step;
  }

  .instruction-list li {
    display: flex;
    gap: 1rem;
    padding: 1.25rem 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .step-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: #ff3366;
    color: #fff;
    font-weight: 700;
    font-size: 0.875rem;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .instruction-list p {
    margin: 0;
    color: #333;
    line-height: 1.7;
  }

  /* Nutrition Grid (Mobile) */
  .mobile-only {
    display: block;
  }

  .desktop-only {
    display: none;
  }

  @media (min-width: 1024px) {
    .mobile-only {
      display: none;
    }

    .desktop-only {
      display: block;
    }
  }

  .nutrition-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 1rem;
  }

  .nutrition-item {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
  }

  .nutrition-value {
    display: block;
    font-size: 1.25rem;
    font-weight: 700;
    color: #111;
  }

  .nutrition-label {
    display: block;
    font-size: 0.75rem;
    color: #666;
    text-transform: capitalize;
    margin-top: 0.25rem;
  }

  /* FAQs */
  .faq-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .faq-item {
    background: #f8f8f8;
    border-radius: 8px;
    overflow: hidden;
  }

  .faq-item summary {
    padding: 1rem 1.25rem;
    font-weight: 600;
    color: #222;
    cursor: pointer;
    list-style: none;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .faq-item summary::-webkit-details-marker {
    display: none;
  }

  .faq-item summary::after {
    content: "+";
    font-size: 1.25rem;
    color: #999;
  }

  .faq-item[open] summary::after {
    content: "âˆ’";
  }

  .faq-answer {
    padding: 0 1.25rem 1rem;
    color: #555;
    line-height: 1.6;
  }

  /* Sidebar */
  .sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .sidebar-sticky {
    position: sticky;
    top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .sidebar-widget {
    background: #fff;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
  }

  .sidebar-widget h3 {
    font-size: 1.125rem;
    font-weight: 700;
    color: #111;
    margin: 0 0 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 3px solid #111;
  }

  .nutrition-list {
    display: flex;
    flex-direction: column;
  }

  .nutrition-row {
    display: flex;
    justify-content: space-between;
    padding: 0.625rem 0;
    border-bottom: 1px solid #eee;
    font-size: 0.9375rem;
  }

  .nutrition-key {
    color: #333;
    font-weight: 500;
    text-transform: capitalize;
  }

  .nutrition-val {
    color: #666;
  }

  /* Mobile Responsive Styles */
  @media (max-width: 768px) {
    .recipe-container {
      padding: 0;
    }

    .main-content {
      padding: 1rem;
      border-radius: 0;
    }

    .recipe-title {
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .recipe-description {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .hero-image {
      margin: 1rem 0;
      border-radius: 0;
    }

    .hero-image img {
      border-radius: 0;
    }

    .disclosure-notice {
      padding: 0.875rem 1rem;
      font-size: 0.75rem;
      margin: 1rem 0;
      border-radius: 0;
    }

    .recipe-meta-pills {
      gap: 0.5rem;
      padding: 1rem 0;
    }

    .meta-pill {
      padding: 0.5rem 0.75rem;
      min-width: auto;
      flex: none;
    }

    .meta-pill .label {
      display: none;
    }

    .meta-pill .icon {
      width: 16px;
      height: 16px;
    }

    .content-section h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }

    .content-section h3 {
      font-size: 1rem;
    }

    .tldr-section {
      margin: 0 -1rem 2rem;
      padding: 1rem;
      border-radius: 0;
    }

    .ingredient-list li {
      padding: 0.5rem 0;
      font-size: 0.9375rem;
    }

    .checkbox {
      width: 18px;
      height: 18px;
    }

    .instruction-list li {
      padding: 1rem 0;
    }

    .step-number {
      width: 28px;
      height: 28px;
      font-size: 0.75rem;
    }

    .instruction-list p {
      font-size: 0.9375rem;
      line-height: 1.6;
    }

    .faq-item summary {
      padding: 0.875rem 1rem;
      font-size: 0.9375rem;
    }

    .faq-answer {
      padding: 0 1rem 0.875rem;
      font-size: 0.875rem;
    }

    .sidebar {
      margin-top: 0;
      gap: 0;
    }

    .sidebar-sticky {
      position: static;
      gap: 0;
    }

    .sidebar-widget {
      border-radius: 0;
    }
  }

  @media (max-width: 480px) {
    .main-content {
      padding: 1rem;
    }

    .category-badge {
      font-size: 0.6875rem;
      padding: 0.3rem 0.625rem;
    }

    .recipe-title {
      font-size: 1.375rem;
    }

    .recipe-meta-pills {
      flex-wrap: wrap;
    }

    .meta-pill {
      flex: 1 1 45%;
    }

    .tldr-section {
      margin: 0 -1rem 1.5rem;
      padding: 0.875rem 1rem;
    }
  }
</style>

<script>
  // Interactive checkboxes for ingredients
  document.querySelectorAll(".ingredient-list li").forEach((item) => {
    item.addEventListener("click", () => {
      const checkbox = item.querySelector(".checkbox") as HTMLElement;
      if (checkbox) {
        const isChecked = checkbox.style.background === "rgb(16, 185, 129)";
        if (isChecked) {
          checkbox.style.background = "";
          (item as HTMLElement).style.opacity = "1";
          (item as HTMLElement).style.textDecoration = "none";
        } else {
          checkbox.style.background = "#10b981";
          (item as HTMLElement).style.opacity = "0.6";
          (item as HTMLElement).style.textDecoration = "line-through";
        }
      }
    });
  });
</script>
