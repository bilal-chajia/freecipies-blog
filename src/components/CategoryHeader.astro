---
import type { HydratedCategory } from "@modules/categories";
import type { HydratedArticle } from "@modules/articles";
import { extractImage, getImageSrcSet } from "@shared/utils";

interface Props {
  category: HydratedCategory;
  featuredArticle?: HydratedArticle | null;
  headerStyle?: "hero" | "minimal" | "none";
}

const {
  category,
  featuredArticle = null,
  headerStyle = "hero",
} = Astro.props;

const showHeader = headerStyle !== "none";
const isHeroHeader = headerStyle === "hero";
const isMinimalHeader = headerStyle === "minimal";
const hasFeatured = Boolean(featuredArticle && isHeroHeader);

const getFeaturedImage = (article: HydratedArticle) => {
  const cover = extractImage(article.imagesJson, "cover", 1200);
  const thumbnail = extractImage(article.imagesJson, "thumbnail", 1200);
  const slotName = cover.imageUrl ? "cover" : "thumbnail";
  const selected = cover.imageUrl ? cover : thumbnail;
  const srcSet = getImageSrcSet(article.imagesJson, slotName);
  return { selected, srcSet };
};

const featuredRecipe = featuredArticle?.recipeJson ?? null;
const featuredImage = featuredArticle ? getFeaturedImage(featuredArticle) : null;
const featuredSizes = "(max-width: 1024px) 100vw, 50vw";
---

{showHeader && (
  <section class:list={["category-hero", { "is-minimal": isMinimalHeader }]}>
    <div class:list={["hero-container", { "has-featured": hasFeatured, "is-minimal": isMinimalHeader }]}>
      {
        isHeroHeader && featuredArticle && featuredImage && (
          <a href={`/recipes/${featuredArticle.slug}`} class="featured-card">
            <div class="featured-image">
              {(featuredImage.selected.imageUrl || featuredArticle.imageUrl) && (
                <img
                  src={featuredImage.selected.imageUrl || featuredArticle.imageUrl}
                  alt={featuredImage.selected.imageAlt || featuredArticle.imageAlt || featuredArticle.label}
                  width={featuredImage.selected.imageWidth || featuredArticle.imageWidth || 1200}
                  height={featuredImage.selected.imageHeight || featuredArticle.imageHeight || 900}
                  srcset={featuredImage.srcSet || undefined}
                  sizes={featuredImage.srcSet ? featuredSizes : undefined}
                  loading="eager"
                />
              )}
              <div class="featured-overlay">
                <span class="featured-badge">{category.label}</span>
                <h2 class="featured-title">{featuredArticle.label}</h2>
                <div class="featured-meta">
                  {featuredRecipe?.cookTime && (
                    <span>{featuredRecipe.cookTime}</span>
                  )}
                </div>
              </div>
            </div>
          </a>
        )
      }
      <div class:list={["hero-content", { "is-minimal": isMinimalHeader }]}>
        <h1 class="category-title">{category.headline || category.label}</h1>
        <p class="category-description">
          {category.shortDescription || category.headline}
        </p>
        {category.tldr && (
          <p class="category-tldr">
            {category.tldr}
          </p>
        )}
        {isHeroHeader && (
          <a href="#newsletter" class="cta-button"> Join My Mailing List </a>
        )}
      </div>
    </div>
  </section>
)}

<style>
  /* Hero Section */
  .category-hero {
    background: #1a1a1a;
    padding: 2rem 0;
  }

  .category-hero.is-minimal {
    background: #fff;
    padding: 2rem 0 1rem;
  }

  .hero-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 clamp(1rem, 3vw, 2rem);
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    align-items: center;
  }

  @media (min-width: 1024px) {
    .hero-container.has-featured {
      grid-template-columns: 1fr 1fr;
    }
  }

  .featured-card {
    display: block;
    text-decoration: none;
    border-radius: 16px;
    overflow: hidden;
    position: relative;
  }

  .featured-image {
    position: relative;
    aspect-ratio: 4/3;
  }

  .featured-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .featured-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 2rem;
    background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
  }

  .featured-badge {
    display: inline-block;
    background: #ff3366;
    color: white;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    padding: 0.375rem 0.75rem;
    border-radius: 4px;
    margin-bottom: 0.75rem;
  }

  .featured-title {
    color: white;
    font-size: clamp(1.25rem, 3vw, 1.75rem);
    font-weight: 700;
    line-height: 1.3;
    margin: 0 0 0.5rem;
  }

  .featured-meta {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.875rem;
  }

  .hero-content {
    color: white;
    text-align: center;
  }

  .hero-content.is-minimal {
    color: #111;
    text-align: left;
  }

  @media (min-width: 1024px) {
    .hero-content {
      text-align: right;
      padding-right: 2rem;
    }
    .hero-content.is-minimal {
      text-align: left;
      padding-right: 0;
    }
  }

  .category-title {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 800;
    margin: 0 0 1rem;
  }

  .category-description {
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.8);
    line-height: 1.7;
    margin: 0 0 2rem;
  }

  .category-hero.is-minimal .category-description {
    color: #444;
  }

  .cta-button {
    display: inline-block;
    background: white;
    color: #1a1a1a;
    padding: 0.875rem 2rem;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .cta-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
  }
</style>
