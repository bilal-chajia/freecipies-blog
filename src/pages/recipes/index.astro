---
import Layout from "../../layouts/Layout.astro";
import { getArticles } from "@modules/articles";
import { getCategories } from "@modules/categories";
import { getTags } from "@modules/tags";
import {
  extractImage,
  getImageSrcSet,
  hydrateArticles,
  hydrateCategories,
  hydrateTags,
} from "@shared/utils";

export const prerender = false;

const { env } = Astro.locals.runtime;

// Get filter params from URL
const url = Astro.url;
const categoryFilter = url.searchParams.get("category") || "";
const tagFilter = url.searchParams.get("tag") || "";
const page = parseInt(url.searchParams.get("page") || "1");
const limit = 12;
const offset = (page - 1) * limit;

// Fetch data - use any[] to avoid complex type inference issues with hydration
let recipes: any[] = [];
let totalRecipes = 0;
let categories: any[] = [];
let tags: any[] = [];

try {
  // Get articles with optional filter
  const result = await getArticles(env.DB, {
    type: "recipe",
    categorySlug: categoryFilter || undefined,
    tagSlug: tagFilter || undefined,
    limit,
    offset,
  });
  recipes = hydrateArticles(result.items);
  totalRecipes = result.total;

  // Get all categories and tags for filters
  const rawCategories = await getCategories(env.DB, { isOnline: true });
  const rawTags = await getTags(env.DB);
  categories = hydrateCategories(rawCategories);
  tags = hydrateTags(rawTags);
} catch (error) {
  console.error("Error fetching recipes:", error);
}

const totalPages = Math.ceil(totalRecipes / limit);

// Helper to build filter URL
const buildFilterUrl = (
  newCategory?: string,
  newTag?: string,
  newPage?: number
) => {
  const params = new URLSearchParams();
  const cat = newCategory !== undefined ? newCategory : categoryFilter;
  const tag = newTag !== undefined ? newTag : tagFilter;
  const p = newPage !== undefined ? newPage : page;

  if (cat) params.set("category", cat);
  if (tag) params.set("tag", tag);
  if (p > 1) params.set("page", p.toString());

  const queryString = params.toString();
  return queryString ? `/recipes?${queryString}` : "/recipes";
};

const getRecipeImage = (
  recipe: any,
  targetWidth: number,
  prefer: "cover" | "thumbnail" = "cover"
) => {
  const cover = extractImage(recipe.imagesJson, "cover", targetWidth);
  const thumbnail = extractImage(recipe.imagesJson, "thumbnail", targetWidth);
  const slotName =
    prefer === "cover"
      ? cover.imageUrl
        ? "cover"
        : "thumbnail"
      : thumbnail.imageUrl
        ? "thumbnail"
        : "cover";
  const selected = slotName === "cover" ? cover : thumbnail;
  const srcSet = getImageSrcSet(recipe.imagesJson, slotName);
  return { selected, srcSet };
};

const parseHexColor = (value?: string) => {
  if (!value) return null;
  const trimmed = value.trim();
  const match = trimmed.startsWith("#") ? trimmed.slice(1) : trimmed;
  if (!/^[0-9a-fA-F]+$/.test(match)) return null;
  if (match.length === 3 || match.length === 4) {
    const [r, g, b] = match.slice(0, 3).split("");
    return `${r}${r}${g}${g}${b}${b}`;
  }
  if (match.length === 6 || match.length === 8) {
    return match.slice(0, 6);
  }
  return null;
};

const getBadgeTextColor = (background?: string) => {
  const hex = parseHexColor(background);
  if (!hex) return "#ffffff";
  const r = parseInt(hex.slice(0, 2), 16);
  const g = parseInt(hex.slice(2, 4), 16);
  const b = parseInt(hex.slice(4, 6), 16);
  const yiq = (r * 299 + g * 587 + b * 114) / 1000;
  return yiq >= 170 ? "#111111" : "#ffffff";
};

const getBadgeColors = (color?: string) => {
  const badgeColor = color && color.trim() ? color.trim() : "#ff3366";
  const badgeText = getBadgeTextColor(badgeColor);
  return { badgeColor, badgeText };
};

const siteTitle = categoryFilter
  ? `${categories.find((c) => c.slug === categoryFilter)?.label || "Category"} Recipes - Freecipies`
  : "All Recipes - Freecipies";
const siteDescription =
  "Browse all our delicious and easy-to-follow recipes. Filter by category or tag.";
---

<Layout title={siteTitle} description={siteDescription}>
  <main class="recipes-page">
    <!-- Page Header -->
    <section class="page-header">
      <div class="container">
        <h1 class="page-title">
          <span class="title-dot"></span>
          {
            categoryFilter
              ? `${categories.find((c) => c.slug === categoryFilter)?.label} Recipes`
              : "All Recipes"
          }
        </h1>
        <p class="recipe-count">{totalRecipes} recipes found</p>
      </div>
    </section>

    <!-- Category Filter Pills -->
    <section class="filters-section">
      <div class="container">
        <div class="filter-pills">
          <a
            href="/recipes"
            class:list={[
              "filter-pill",
              { active: !categoryFilter && !tagFilter },
            ]}
          >
            All
          </a>
          {
            categories.map((cat) => (
              <a
                href={buildFilterUrl(
                  cat.slug === categoryFilter ? "" : cat.slug,
                  undefined,
                  1
                )}
                class:list={[
                  "filter-pill",
                  { active: categoryFilter === cat.slug },
                ]}
              >
                {cat.label}
              </a>
            ))
          }
        </div>
      </div>
    </section>

    <!-- Tag Chips -->
    {
      tags.length > 0 && (
        <section class="tags-section">
          <div class="container">
            <div class="tag-chips">
              {tags.slice(0, 8).map((tag) => (
                <a
                  href={buildFilterUrl(
                    undefined,
                    tag.slug === tagFilter ? "" : tag.slug,
                    1
                  )}
                  class:list={["tag-chip", { active: tagFilter === tag.slug }]}
                  style={`--tag-color: ${tag.color || "#ff6600"};`}
                >
                  <div class="chip-image">
                    {tag.imageUrl ? (
                      <img src={tag.imageUrl} alt={tag.label} />
                    ) : (
                      <div class="chip-placeholder">{tag.label.charAt(0)}</div>
                    )}
                  </div>
                  <span class="chip-label">{tag.label}</span>
                </a>
              ))}
            </div>
          </div>
        </section>
      )
    }

    <!-- Active Filters -->
    {
      (categoryFilter || tagFilter) && (
        <section class="active-filters">
          <div class="container">
            <div class="filter-tags">
              {categoryFilter && (
                <span class="filter-tag">
                  Category:{" "}
                  {categories.find((c) => c.slug === categoryFilter)?.label}
                  <a
                    href={buildFilterUrl("", tagFilter, 1)}
                    class="remove-filter"
                  >
                    ×
                  </a>
                </span>
              )}
              {tagFilter && (
                <span class="filter-tag">
                  Tag: {tags.find((t) => t.slug === tagFilter)?.label}
                  <a
                    href={buildFilterUrl(categoryFilter, "", 1)}
                    class="remove-filter"
                  >
                    ×
                  </a>
                </span>
              )}
              <a href="/recipes" class="clear-all">
                Clear All
              </a>
            </div>
          </div>
        </section>
      )
    }

    <!-- Recipe Grid -->
    <section class="recipes-grid-section">
      <div class="container">
        <h2 class="sr-only">Recipe results</h2>
        {
          recipes.length > 0 ? (
            <div class="recipes-grid">
              {recipes.map((recipe) => {
                const { selected, srcSet } = getRecipeImage(recipe, 400, "cover");
                const sizes = "(max-width: 768px) 50vw, 25vw";
                const { badgeColor, badgeText } = getBadgeColors(recipe.categoryColor);
                return (
                  <article class="recipe-card">
                    <button
                      type="button"
                      class="recipe-bookmark"
                      data-bookmark-button
                      data-bookmark-slug={recipe.slug}
                      aria-pressed="false"
                      aria-label="Bookmark recipe"
                    >
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 4a2 2 0 012-2h8a2 2 0 012 2v18l-6-4-6 4V4z" />
                      </svg>
                    </button>
                    <a href={`/recipes/${recipe.slug}`} class="card-image-link">
                      {(selected.imageUrl || recipe.imageUrl) && (
                        <img
                          src={selected.imageUrl || recipe.imageUrl}
                          alt={selected.imageAlt || recipe.imageAlt || recipe.headline}
                          width={selected.imageWidth || recipe.imageWidth || 400}
                          height={selected.imageHeight || recipe.imageHeight || 300}
                          srcset={srcSet || undefined}
                          sizes={srcSet ? sizes : undefined}
                          loading="lazy"
                        />
                      )}
                      <span
                        class="card-badge"
                        style={`background: ${badgeColor}; color: ${badgeText};`}
                      >
                        {recipe.categoryLabel}
                      </span>
                    </a>
                    <div class="card-body">
                      <h3 class="card-title">
                        <a href={`/recipes/${recipe.slug}`}>{recipe.headline}</a>
                      </h3>
                      <div class="card-meta">
                        {recipe.recipeJson?.prepTime && (
                          <span class="meta-item">
                            <svg
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                            >
                              <circle cx="12" cy="12" r="10" />
                              <path d="M12 6v6l4 2" />
                            </svg>
                            {recipe.recipeJson.prepTime}
                          </span>
                        )}
                        {recipe.recipeJson?.servings && (
                          <span class="meta-item">
                            <svg
                              viewBox="0 0 24 24"
                              fill="none"
                              stroke="currentColor"
                              stroke-width="2"
                            >
                              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                              <circle cx="9" cy="7" r="4" />
                            </svg>
                            {recipe.recipeJson.servings}
                          </span>
                        )}
                      </div>
                    </div>
                  </article>
                );
              })}
            </div>
          ) : (
            <div class="no-recipes">
              <p>No recipes found matching your filters.</p>
              <a href="/recipes" class="reset-btn">
                View All Recipes
              </a>
            </div>
          )
        }

        <!-- Pagination -->
        {
          totalPages > 1 && (
            <nav class="pagination">
              {page > 1 && (
                <a
                  href={buildFilterUrl(undefined, undefined, page - 1)}
                  class="page-btn prev"
                >
                  ← Previous
                </a>
              )}
              <div class="page-numbers">
                {Array.from({ length: totalPages }, (_, i) => i + 1).map(
                  (p) => (
                    <a
                      href={buildFilterUrl(undefined, undefined, p)}
                      class:list={["page-num", { active: p === page }]}
                    >
                      {p}
                    </a>
                  )
                )}
              </div>
              {page < totalPages && (
                <a
                  href={buildFilterUrl(undefined, undefined, page + 1)}
                  class="page-btn next"
                >
                  Next →
                </a>
              )}
            </nav>
          )
        }
      </div>
    </section>
  </main>
</Layout>

<style>
  .recipes-page {
    background: #fafafa;
    min-height: 100vh;
  }

  .container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 clamp(1rem, 3vw, 2rem);
  }

  /* Page Header */
  .page-header {
    background: #fff;
    padding: 3rem 0;
    border-bottom: 1px solid #eee;
  }

  .page-title {
    font-size: clamp(2rem, 4vw, 2.5rem);
    font-weight: 800;
    color: #111;
    margin: 0 0 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .title-dot {
    width: 12px;
    height: 12px;
    background: #ff3366;
    border-radius: 50%;
  }

  .recipe-count {
    color: #666;
    font-size: 1rem;
    margin: 0;
  }

  /* Filter Pills */
  .filters-section {
    background: #fff;
    padding: 1.5rem 0;
    border-bottom: 1px solid #eee;
  }

  .filter-pills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .filter-pill {
    padding: 0.625rem 1.25rem;
    border: 1px solid #ddd;
    border-radius: 50px;
    background: #fff;
    color: #333;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .filter-pill:hover,
  .filter-pill.active {
    background: #111;
    color: #fff;
    border-color: #111;
  }

  /* Tag Chips */
  .tags-section {
    background: #fff;
    padding: 2rem 0;
  }

  .tag-chips {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 2rem;
  }

  .tag-chip {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    transition: transform 0.2s ease;
  }

  .tag-chip:hover {
    transform: translateY(-4px);
  }

  .chip-image {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    overflow: hidden;
    border: 3px solid transparent;
    transition: border-color 0.2s ease;
  }

  .tag-chip:hover .chip-image,
  .tag-chip.active .chip-image {
    border-color: var(--tag-color, #ff6600);
  }

  .chip-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .chip-placeholder {
    width: 100%;
    height: 100%;
    background: var(--tag-color, #ff6600);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    font-weight: 700;
  }

  .chip-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: #222;
  }

  .tag-chip.active .chip-label {
    color: var(--tag-color, #ff6600);
  }

  /* Active Filters */
  .active-filters {
    padding: 1rem 0;
    background: #f5f5f5;
  }

  .filter-tags {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
  }

  .filter-tag {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.375rem 0.75rem;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.8125rem;
    color: #333;
  }

  .remove-filter {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 18px;
    height: 18px;
    background: #eee;
    border-radius: 50%;
    color: #666;
    text-decoration: none;
    font-size: 1rem;
    line-height: 1;
  }

  .remove-filter:hover {
    background: #ff3366;
    color: #fff;
  }

  .clear-all {
    color: #ff3366;
    font-size: 0.8125rem;
    font-weight: 500;
    text-decoration: none;
  }

  .clear-all:hover {
    text-decoration: underline;
  }

  /* Recipe Grid */
  .recipes-grid-section {
    padding: 3rem 0;
  }

  .recipes-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
  }

  @media (max-width: 1024px) {
    .recipes-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .recipes-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: 1.5rem;
    }
  }

  @media (max-width: 480px) {
    .recipes-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Recipe Card */
  .recipe-card {
    background: #fff;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
    position: relative;
  }

  .recipe-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
  }

  .card-image-link {
    display: block;
    position: relative;
    aspect-ratio: 4/3;
    overflow: hidden;
  }

  .recipe-bookmark {
    position: absolute;
    top: 12px;
    right: 12px;
    width: 36px;
    height: 36px;
    border-radius: 9999px;
    border: none;
    background: rgba(0, 0, 0, 0.7);
    color: #fff;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 18px rgba(0, 0, 0, 0.25);
    cursor: pointer;
    z-index: 2;
  }

  .recipe-bookmark svg {
    width: 18px;
    height: 18px;
  }

  .recipe-bookmark[data-bookmarked="true"] {
    background: #ef4444;
    color: #fff;
  }

  .card-image-link img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.4s ease;
  }

  .recipe-card:hover .card-image-link img {
    transform: scale(1.05);
  }

  .card-badge {
    position: absolute;
    bottom: 12px;
    left: 12px;
    background: #b3123c;
    color: white;
    padding: 0.375rem 0.875rem;
    border-radius: 4px;
    font-size: 0.6875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .card-body {
    padding: 1rem;
  }

  .card-title {
    font-size: 1rem;
    font-weight: 700;
    line-height: 1.4;
    margin: 0 0 0.75rem;
    color: #111;
  }

  .card-title a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .card-title a:hover {
    color: #ff3366;
  }

  .card-meta {
    display: flex;
    gap: 1rem;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: #666;
  }

  .meta-item svg {
    width: 14px;
    height: 14px;
  }

  /* No Recipes */
  .no-recipes {
    text-align: center;
    padding: 4rem 2rem;
  }

  .no-recipes p {
    color: #666;
    font-size: 1.125rem;
    margin: 0 0 1.5rem;
  }

  .reset-btn {
    display: inline-block;
    padding: 0.75rem 1.5rem;
    background: #ff3366;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    transition: background 0.2s ease;
  }

  .reset-btn:hover {
    background: #e62e5c;
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 1rem;
    margin-top: 3rem;
  }

  .page-btn {
    padding: 0.625rem 1.25rem;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    color: #333;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .page-btn:hover {
    background: #111;
    color: #fff;
    border-color: #111;
  }

  .page-numbers {
    display: flex;
    gap: 0.5rem;
  }

  .page-num {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 6px;
    background: #fff;
    border: 1px solid #ddd;
    color: #333;
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .page-num:hover,
  .page-num.active {
    background: #ff3366;
    color: #fff;
    border-color: #ff3366;
  }
</style>
