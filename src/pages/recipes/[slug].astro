---
import RecipeLayout from "../../layouts/RecipeLayout.astro";
import SEO from "../../components/SEO.astro";
import { getArticleBySlug, type RecipeDetails } from "@modules/articles";
import { getAuthorById, type Author } from "@modules/authors";
import { getCategoryById, type Category } from "@modules/categories";
import { hydrateArticle, extractImage, getImageSrcSet } from "@shared/utils";

/**
 * In SSR mode, Astro doesn't require getStaticPaths.
 * It renders pages on-demand. We get the slug from Astro.params.
 */

const { slug } = Astro.params;
const { runtime } = Astro.locals;

if (!slug) {
  return new Response("Slug is missing", { status: 400 });
}

let author: Author | null = null;
let category: Category | null = null;

// The D1 binding is available on `runtime.env.DB`
const recipe = await getArticleBySlug(runtime.env.DB, slug, "recipe");

// If no recipe is found for the slug, return a 404 page.
if (!recipe) {
  return new Response("Recipe not found", { status: 404 });
}

const recipeDetails: RecipeDetails | undefined = recipe.recipeJson || undefined;

const heroCover = extractImage(recipe.imagesJson, "cover", 1200);
const heroThumb = extractImage(recipe.imagesJson, "thumbnail", 1200);
const coverSrcSet = getImageSrcSet(recipe.imagesJson, "cover");
const thumbSrcSet = getImageSrcSet(recipe.imagesJson, "thumbnail");
const useCover = heroCover.imageUrl && (coverSrcSet || !heroThumb.imageUrl);
const heroImage = useCover ? heroCover : heroThumb;

// Fetch author data using authorId from the raw article
if (recipe.authorId) {
  author = await getAuthorById(runtime.env.DB, recipe.authorId);
}

// Fetch category data using categoryId from the raw article
if (recipe.categoryId) {
  category = await getCategoryById(runtime.env.DB, recipe.categoryId);
}

const pageTitle = recipe.metaTitle || recipe.headline;
const pageDescription = recipe.metaDescription || recipe.shortDescription;
---

<RecipeLayout recipe={recipe} author={author} category={category}>
  <SEO
    slot="head"
    title={pageTitle}
    description={pageDescription}
    type="recipe"
    publishedTime={recipe.publishedAt || undefined}
    author={{ name: author?.name || "Freecipies Team" }}
    image={heroImage.imageUrl || recipe.imageUrl || ""}
    imageAlt={heroImage.imageAlt || recipe.imageAlt || undefined}
    recipe={recipeDetails
      ? {
          name: recipe.headline,
          description: recipe.shortDescription,
          image: heroImage.imageUrl || recipe.imageUrl || "",
          prepTime: recipeDetails.prepTime
            ? String(recipeDetails.prepTime)
            : undefined,
          cookTime: recipeDetails.cookTime
            ? String(recipeDetails.cookTime)
            : undefined,
          totalTime: undefined,
          recipeYield: recipeDetails.servings
            ? String(recipeDetails.servings)
            : undefined,
          recipeCategory: category?.label,
          recipeIngredient:
            recipeDetails.ingredients?.flatMap((i) =>
              i.items.map((item) => item.name)
            ) || [],
          recipeInstructions:
            recipeDetails.instructions?.flatMap((i) =>
              i.steps.map((step) => step.text)
            ) || [],
        }
      : undefined}
  />

  <!-- Main Recipe Content -->
  <article>
    <h1 class="text-4xl font-bold mb-4">{recipe.headline}</h1>
    <p class="text-lg text-gray-600 mb-8">{recipe.shortDescription}</p>

    {
      recipeDetails ? (
        <div class="prose prose-lg max-w-none">
          <div class="mb-8">
            <h2 class="text-2xl font-semibold border-b pb-2 mb-4">
              Ingredients
            </h2>
            <ul>
              {recipeDetails.ingredients?.map((group) => (
                <>
                  {group.group_title && (
                    <h3 class="font-bold mt-2">{group.group_title}</h3>
                  )}
                  {group.items &&
                    group.items.map((item) => (
                      <li>
                        {item.name}
                        {item.amount
                          ? ` - ${item.amount}${item.unit || ""}`
                          : ""}
                      </li>
                    ))}
                </>
              ))}
            </ul>
          </div>
          <div>
            <h2 class="text-2xl font-semibold border-b pb-2 mb-4">
              Instructions
            </h2>
            <ol>
              {recipeDetails.instructions?.map((group) => (
                <>
                  {group.section_title && (
                    <h3 class="font-bold mt-2">{group.section_title}</h3>
                  )}
                  {group.steps &&
                    group.steps.map((step) => <li>{step.text}</li>)}
                </>
              ))}
            </ol>
          </div>
        </div>
      ) : (
        <p class="text-center text-gray-500 italic mt-12">
          This article does not contain detailed recipe information.
        </p>
      )
    }
  </article>
</RecipeLayout>
