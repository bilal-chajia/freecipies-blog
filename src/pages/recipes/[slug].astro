---
import RecipeLayout from "../../layouts/RecipeLayout.astro";
import SEO from "../../components/SEO.astro";
import {
  getArticleBySlug,
  getAuthorBySlug,
  getCategoryBySlug,
} from "../../lib/db";
import type { Article, Author, RecipeDetails, Category } from "../../types";

/**
 * In SSR mode, Astro doesn't require getStaticPaths.
 * It renders pages on-demand. We get the slug from Astro.params.
 */

const { slug } = Astro.params;
const { runtime } = Astro.locals;

if (!slug) {
  return new Response("Slug is missing", { status: 400 });
}

let recipe: Article | null = null;
let author: Author | null = null;
let category: Category | null = null;
let recipeDetails: RecipeDetails | undefined = undefined;

try {
  // The D1 binding is available on `runtime.env.DB`
  recipe = await getArticleBySlug(runtime.env.DB, slug, "recipe");

  // If no recipe is found for the slug, return a 404 page.
  if (!recipe) {
    return new Response("Recipe not found", { status: 404 });
  }

  // Fetch author data to get the author's image
  if (recipe.authorSlug) {
    author = await getAuthorBySlug(runtime.env.DB, recipe.authorSlug);
  }

  // Fetch category data to get category color
  if (recipe.categorySlug) {
    category = await getCategoryBySlug(runtime.env.DB, recipe.categorySlug);
  }

  // The recipeJson field is already parsed by getArticleBySlug
  recipeDetails = recipe.recipeJson;
} catch (e: any) {
  console.error(`Error processing recipe for slug "${slug}":`, e);
  return new Response("An unexpected error occurred", { status: 500 });
}

// This line will only be reached if recipe is not null
const pageTitle = recipe.metaTitle || recipe.headline;
const pageDescription = recipe.metaDescription || recipe.shortDescription;
---

<RecipeLayout recipe={recipe} author={author} category={category}>
  <SEO
    slot="seo"
    title={pageTitle}
    description={pageDescription}
    type="recipe"
    publishedTime={recipe.publishedAt}
    author={{ name: recipe.authorName || "Freecipies Team" }}
    image={recipe.imageUrl || ""}
    imageAlt={recipe.imageAlt}
    recipe={recipeDetails
      ? {
          name: recipe.headline,
          description: recipe.shortDescription,
          image: recipe.imageUrl || "",
          prepTime: recipeDetails.prepTime,
          cookTime: recipeDetails.cookTime,
          totalTime: undefined,
          recipeYield: recipeDetails.servings,
          recipeCategory: recipe.categoryLabel,
          recipeIngredient:
            recipeDetails.ingredients?.flatMap((i) => i.items || []) || [],
          recipeInstructions:
            recipeDetails.instructions?.flatMap((i) => i.steps || []) || [],
          nutrition: recipeDetails.nutrition,
        }
      : undefined}
  />

  <!-- Main Recipe Content -->
  <article>
    <h1 class="text-4xl font-bold mb-4">{recipe.headline}</h1>
    <p class="text-lg text-gray-600 mb-8">{recipe.shortDescription}</p>

    {
      recipeDetails ? (
        <div class="prose prose-lg max-w-none">
          <div class="mb-8">
            <h2 class="text-2xl font-semibold border-b pb-2 mb-4">
              Ingredients
            </h2>
            <ul>
              {recipeDetails.ingredients?.map((group) => (
                <>
                  {group.group && <h3 class="font-bold mt-2">{group.group}</h3>}
                  {group.items && group.items.map((item) => <li>{item}</li>)}
                </>
              ))}
            </ul>
          </div>
          <div>
            <h2 class="text-2xl font-semibold border-b pb-2 mb-4">
              Instructions
            </h2>
            <ol>
              {recipeDetails.instructions?.map((group) => (
                <>
                  {group.group && <h3 class="font-bold mt-2">{group.group}</h3>}
                  {group.steps && group.steps.map((step) => <li>{step}</li>)}
                </>
              ))}
            </ol>
          </div>
        </div>
      ) : (
        <p class="text-center text-gray-500 italic mt-12">
          This article does not contain detailed recipe information.
        </p>
      )
    }
  </article>
</RecipeLayout>
