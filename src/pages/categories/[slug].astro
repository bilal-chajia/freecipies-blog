---
import Layout from "../../layouts/Layout.astro";
import CategoryHeader from "../../components/CategoryHeader.astro";
import ArticleGrid from "../../components/ArticleGrid.astro";
import Pagination from "../../components/Pagination.astro";
import Breadcrumb from "../../components/Breadcrumb.astro";
import PopularRecipes from "../../components/PopularRecipes.astro";
import NewsletterWidget from "../../components/NewsletterWidget.astro";
import {
  getCategories,
  type HydratedCategory,
} from "@modules/categories";
import { getArticles } from "@modules/articles";
import { hydrateCategories } from "@shared/utils";

const { slug } = Astro.params;
const { env } = Astro.locals.runtime;

if (!slug) {
  return Astro.redirect("/404");
}

// Parse query parameters - only pagination is user-controllable
const url = new URL(Astro.request.url);
const currentPage = Math.max(1, parseInt(url.searchParams.get('page') || '1', 10));

// Fetch all categories in a single query
const allRawCategories = await getCategories(env.DB, { isOnline: true });
const allCategories = hydrateCategories(allRawCategories);

// Find current category
const category = allCategories.find((c) => c.slug === slug);
if (!category) {
  return Astro.redirect("/404");
}

// Display settings come from admin config only (no user overrides)
const perPage = category.numEntriesPerPage || 12;
const sortBy = category.sortBy || 'publishedAt';
const sortOrder = category.sortOrder || 'desc';
const layoutMode = category.layoutMode || 'grid';
const showPagination = category.showPagination !== false;
const showBreadcrumb = category.showBreadcrumb !== false;
const showSidebar = category.showSidebar !== false;
const headerStyle = category.headerStyle || 'hero';
const cardStyle = category.cardStyle || 'full';
const showHeader = headerStyle !== 'none';

// Fetch articles with pagination and sorting
const offset = (currentPage - 1) * perPage;
const { items: articles, total } = await getArticles(env.DB, {
  categorySlug: slug,
  isOnline: true,
  limit: perPage,
  offset,
  sortBy,
  sortOrder,
});

const totalPages = Math.ceil(total / perPage);
const featuredArticle = currentPage === 1 && headerStyle === 'hero' ? articles[0] : null;
const gridArticles = featuredArticle ? articles.slice(1) : articles;

// Base URL for pagination
const baseUrl = `/categories/${slug}`;
---

<Layout title={category.metaTitle || category.headline || category.label} description={category.metaDescription || category.shortDescription}>
  <!-- Hero Section -->
  <CategoryHeader
    category={category}
    featuredArticle={featuredArticle}
    headerStyle={headerStyle}
  />

  <!-- Recipe Grid -->
<section class:list={["recipes-section", { "no-hero": !showHeader }]}>
  <div class="container">
    {showBreadcrumb && (
      <Breadcrumb items={[
        { label: 'CatÃ©gories', href: '/categories' },
        { label: category.label }
      ]} />
    )}
    
    <div class="section-header">
      <h2 class="section-title">{category.collectionTitle || `${category.label} Recipes`}</h2>
      <span class="recipe-count">{total} recette{total > 1 ? 's' : ''}</span>
    </div>

    <div class:list={["recipes-layout", { "with-sidebar": showSidebar }]}>
      <div class="recipes-main">
        {
          gridArticles.length > 0 ? (
            <ArticleGrid
              articles={gridArticles}
              layoutMode={layoutMode}
              cardStyle={cardStyle}
            />
          ) : articles.length === 0 ? (
            <div class="empty-state">
              <p>No recipes found in this category yet.</p>
            </div>
          ) : null
        }
        
        {showPagination && totalPages > 1 && (
          <Pagination 
            currentPage={currentPage}
            totalPages={totalPages}
            baseUrl={baseUrl}
          />
        )}
      </div>

      {showSidebar && (
        <aside class="recipes-sidebar">
          <PopularRecipes limit={5} />
          <NewsletterWidget />
        </aside>
      )}
    </div>
    </div>
  </section>

  <!-- Category Navigation - Always visible, excludes current category -->
  <section class="category-nav-section">
    <div class="container">
      <h2 class="nav-title">Explore More Categories</h2>
      <div class="category-chips">
        {allCategories
          .filter((cat: HydratedCategory) => cat.slug !== slug)
          .slice(0, 6)
          .map((cat: HydratedCategory) => (
          <a
            href={`/categories/${cat.slug}`}
            class="category-chip"
          >
            <div class="chip-svg">
              {cat.iconSvg ? (
                <Fragment set:html={cat.iconSvg} />
              ) : (
                <div class="chip-placeholder" style={`background-color: ${cat.color || '#ff3366'}`}>
                  <span>{cat.label.charAt(0)}</span>
                </div>
              )}
            </div>
            <span class="chip-label">{cat.label}</span>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Newsletter Section -->
  <section class="newsletter-section" id="newsletter">
    <div class="newsletter-bar">
      <div class="newsletter-content">
        <div class="newsletter-icon">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
            <circle cx="12" cy="12" r="10" fill="#ff6b35"></circle>
            <path
              d="M8 12l2 2 4-4"
              stroke="white"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"></path>
          </svg>
        </div>
        <div class="newsletter-text">
          <h3>Keep Current at All Times</h3>
          <p>Subscribe Now for Immediate Updates on My Latest Recipes!</p>
        </div>
      </div>
      <form class="newsletter-form">
        <input type="email" placeholder="Your email address" required />
        <label class="terms-checkbox">
          <input type="checkbox" required />
          <span>I have read and agree to the terms & conditions</span>
        </label>
        <button type="submit">Sign Up Now</button>
      </form>
    </div>
  </section>
</Layout>

<style>
  /* Category Navigation */
  .category-nav-section {
    padding: 3rem 0;
    background: #fff;
  }

  .container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 clamp(1rem, 3vw, 2rem);
  }

  .nav-title {
    text-align: center;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 2rem;
    color: #111;
  }

  .category-chips {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1.5rem;
  }

  .category-chip {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    padding: 0.5rem;
    border-radius: 12px;
    transition: all 0.2s ease;
    min-width: 100px;
  }

  .category-chip:hover,
  .category-chip.active {
    transform: translateY(-4px);
  }

  /* SVG illustration container */
  .chip-svg {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    background: #f8f9fa;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .chip-svg svg,
  .chip-svg :global(svg) {
    width: 70%;
    height: 70%;
    display: block;
  }

  /* Placeholder when no SVG (shows first letter) */
  .chip-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
  }

  .chip-placeholder span {
    font-size: 2rem;
    font-weight: 700;
    color: white;
    text-transform: uppercase;
  }

  .category-chip:hover .chip-svg {
    transform: scale(1.1);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  }

  .chip-label {
    font-size: 0.8rem;
    font-weight: 600;
    color: #222;
    text-align: center;
    max-width: 90px;
  }

  /* Recipes Section */
  .recipes-section {
    padding: 3rem 0 4rem;
    background: #fafafa;
  }

  .recipes-section.no-hero {
    padding-top: 2rem;
  }

  .recipes-layout {
    display: grid;
    gap: 2rem;
  }

  .recipes-layout.with-sidebar {
    grid-template-columns: minmax(0, 1fr) 320px;
    align-items: start;
  }

  .recipes-main {
    min-width: 0;
  }

  .recipes-sidebar {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (max-width: 1024px) {
    .recipes-layout.with-sidebar {
      grid-template-columns: 1fr;
    }
  }

  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111;
    margin: 0;
  }

  .recipe-count {
    font-size: 0.875rem;
    color: #374151;
    background: #e5e7eb;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #5f5f5f;
  }

  /* Newsletter Section */
  .newsletter-section {
    background: #1a1a1a;
    padding: 2rem 0;
  }

  .newsletter-bar {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 clamp(1rem, 3vw, 2rem);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 2rem;
  }

  .newsletter-content {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .newsletter-text h3 {
    color: white;
    font-size: 1.25rem;
    margin: 0 0 0.25rem;
  }

  .newsletter-text p {
    color: #ff6b35;
    font-size: 0.875rem;
    margin: 0;
  }

  .newsletter-form {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 1rem;
  }

  .newsletter-form input[type="email"] {
    padding: 0.75rem 1rem;
    background: #2a2a2a;
    border: 1px solid #3a3a3a;
    border-radius: 6px;
    color: white;
    font-size: 0.9375rem;
    min-width: 250px;
  }

  .newsletter-form input[type="email"]::placeholder {
    color: #666;
  }

  .terms-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #888;
    font-size: 0.75rem;
    cursor: pointer;
  }

  .terms-checkbox input {
    width: 16px;
    height: 16px;
  }

  .newsletter-form button {
    padding: 0.75rem 1.5rem;
    background: linear-gradient(135deg, #ff3366, #ff6b35);
    border: none;
    border-radius: 6px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s;
  }

  .newsletter-form button:hover {
    transform: translateY(-1px);
  }
</style>






